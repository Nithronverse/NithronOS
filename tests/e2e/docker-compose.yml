version: '3.9'

services:
  # PostgreSQL for testing
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: nithronos_test
      POSTGRES_USER: nithronos
      POSTGRES_PASSWORD: testpass123
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - nithronos_test
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U nithronos"]
      interval: 5s
      timeout: 5s
      retries: 10

  # Redis for caching/sessions
  redis:
    image: redis:7-alpine
    command: redis-server --requirepass testpass123
    networks:
      - nithronos_test
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10

  # nos-agent (mock for testing)
  nos-agent:
    build:
      context: ../../
      dockerfile: tests/e2e/Dockerfile.agent
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - agent_socket:/run
    networks:
      - nithronos_test
    privileged: true
    healthcheck:
      test: ["CMD", "test", "-S", "/run/nos-agent.sock"]
      interval: 5s
      timeout: 3s
      retries: 10

  # nosd API server
  nosd:
    build:
      context: ../../
      dockerfile: tests/e2e/Dockerfile.nosd
    environment:
      NOS_ENV: test
      NOS_DB_HOST: postgres
      NOS_DB_USER: nithronos
      NOS_DB_PASSWORD: testpass123
      NOS_DB_NAME: nithronos_test
      NOS_REDIS_HOST: redis
      NOS_REDIS_PASSWORD: testpass123
      NOS_AGENT_SOCKET: /run/nos-agent.sock
      NOS_LOG_LEVEL: debug
      NOS_SETUP_MODE: true
    volumes:
      - agent_socket:/run:ro
      - nos_data:/var/lib/nos
      - nos_config:/etc/nos
    networks:
      - nithronos_test
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      nos-agent:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/api/v1/health"]
      interval: 5s
      timeout: 3s
      retries: 10

  # Caddy web server
  caddy:
    image: caddy:2-alpine
    ports:
      - "8080:80"
      - "8443:443"
    volumes:
      - ./Caddyfile.test:/etc/caddy/Caddyfile:ro
      - ../../web/dist:/usr/share/nithronos/web:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - nithronos_test
    depends_on:
      nosd:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 5s
      timeout: 3s
      retries: 10

  # Mock SMTP server for testing emails
  mailhog:
    image: mailhog/mailhog:latest
    ports:
      - "1025:1025"  # SMTP
      - "8025:8025"  # Web UI
    networks:
      - nithronos_test

  # Mock webhook receiver
  webhook-mock:
    image: tarampampam/webhook-tester:latest
    ports:
      - "8084:8080"
    networks:
      - nithronos_test

networks:
  nithronos_test:
    driver: bridge

volumes:
  postgres_data:
  agent_socket:
  nos_data:
  nos_config:
  caddy_data:
  caddy_config:
