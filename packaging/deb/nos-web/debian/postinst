#!/bin/sh
set -e

# Assets are installed under /usr/share/nithronos/web via debian/rules

# Ensure Caddy config directory exists
install -d -m 0755 /etc/caddy
# Install default Caddyfile from package (do not overwrite admin changes)
if [ ! -f /etc/caddy/Caddyfile ]; then
    install -D -m 0644 /usr/share/doc/nos-web/examples/Caddyfile /etc/caddy/Caddyfile || true
fi

# Ensure local TLS exists for first boot
install -d -m 0700 /etc/nithronos/tls
if [ ! -s /etc/nithronos/tls/cert.pem ] || [ ! -s /etc/nithronos/tls/key.pem ]; then
    # Try to derive a reasonable CN: primary IPv4 or hostname
    CN=$(ip -4 route get 1.1.1.1 2>/dev/null | awk '/src/ {for(i=1;i<=NF;i++) if ($i=="src") {print $(i+1); exit}}')
    [ -z "$CN" ] && CN=$(hostname -I 2>/dev/null | awk '{print $1}')
    [ -z "$CN" ] && CN=$(hostname)
    openssl req -x509 -newkey ec -pkeyopt ec_paramgen_curve:P-256 \
      -days 3650 -sha256 -nodes -subj "/CN=$CN" \
      -keyout /etc/nithronos/tls/key.pem -out /etc/nithronos/tls/cert.pem \
      -addext "subjectAltName=IP:127.0.0.1,DNS:nithronos.local"
fi
# Key perms for Caddy
chown root:caddy /etc/nithronos/tls/key.pem || true
chmod 640 /etc/nithronos/tls/key.pem || true

# Allow binding to 80/443 if needed
if command -v setcap >/dev/null 2>&1; then
    setcap -q 'cap_net_bind_service=+ep' /usr/bin/caddy || true
fi

systemctl daemon-reload || true
if systemctl is-enabled --quiet caddy 2>/dev/null; then
    systemctl restart caddy || true
else
    systemctl enable --now caddy || true
fi

exit 0


