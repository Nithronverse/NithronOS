#!/bin/sh
set -e

case "$1" in
    configure)
        # Verify required binaries exist; log to journal
        REQUIRED_CMDS="btrfs smartctl cryptsetup lsblk mount mdadm lvm"
        for cmd in $REQUIRED_CMDS; do
            if command -v "$cmd" >/dev/null 2>&1; then
                logger -t nithronos-deps "found $cmd: $(command -v "$cmd")"
            else
                logger -t nithronos-deps "MISSING $cmd - please install required runtime tools"
            fi
        done

        # Log versions on first install
        if command -v btrfs >/dev/null 2>&1; then logger -t nithronos-deps "$(btrfs --version)"; fi
        if command -v smartctl >/dev/null 2>&1; then logger -t nithronos-deps "$(smartctl -V | head -1)"; fi
        if command -v cryptsetup >/dev/null 2>&1; then logger -t nithronos-deps "$(cryptsetup --version)"; fi
        if command -v lsblk >/dev/null 2>&1; then logger -t nithronos-deps "$(lsblk --version | head -1)"; fi

        # Install-time: ensure systemd sees our unit; enable for first boot
        systemctl daemon-reload || true
        chmod 0755 /usr/lib/nithronos/report-deps.sh || true
        systemctl enable nithronos-deps-report.service || true
        # Ensure permissions for installed helpers
        chmod 0755 /usr/lib/nithronos/gen-local-cert.sh || true
        # Enable TLS generator and core services
        systemctl enable nithronos-certgen.service || true
        systemctl enable caddy.service || true
        systemctl enable nosd.service || true
        systemctl enable nos-agent.service || true
        systemctl enable nithronos-firstboot-banner.service || true
        # OTP announcer moved to nosd package
        chmod 0755 /usr/lib/nithronos/smart-scan.sh || true
        systemctl enable --now nos-smart-scan.timer || true
        systemctl enable --now nos-fstrim.timer || true
        ;;
esac

exit 0


