# NithronOS ISO Boot GRUB Configuration

# Load modules for graphics and theming
insmod all_video
insmod gfxterm
insmod gfxmenu
insmod png
insmod jpeg

# Set graphics mode
set gfxmode=1024x768,auto
set gfxpayload=keep

# Enable graphics terminal
terminal_output gfxterm

# Load fonts
if loadfont /boot/grub/themes/nithron/DroidSans-32.pf2 ; then
  set gfxterm_font="DroidSans Regular 32"
fi

if loadfont /boot/grub/unicode.pf2 ; then
  true
fi

# Set theme
set theme=/boot/grub/themes/nithron/theme.txt
export theme

# Menu configuration
# Make LIVE the default (index 0) with short timeout to keep UX snappy in CI/VMs
set default=0
set timeout=5
set timeout_style=menu

# Background image fallback
if [ -f /boot/grub/themes/nithron/background.png ]; then
  background_image /boot/grub/themes/nithron/background.png
fi

# Menu entries
# NOTE: Installer entries force text mode and disable KMS to avoid black screens on some hypervisors.
menuentry "NithronOS Live (amd64)" --class nithronos --class gnu-linux --class gnu --class os {
  echo "Loading NithronOS..."
  linux   /live/vmlinuz boot=live components quiet splash console=tty0 console=ttyS0,115200
  initrd  /live/initrd.img
}

# Keep live fallbacks, but not required for installer reliability
menuentry "NithronOS Live (Safe Graphics)" --class nithronos --class gnu-linux --class gnu --class os {
  echo "Loading NithronOS with safe graphics..."
  linux   /live/vmlinuz boot=live components nomodeset console=tty0 console=ttyS0,115200
  initrd  /live/initrd.img
}

# Debian Installer entries â€” force text frontend by default to avoid blank screen on some VMs/KMS.
# Do NOT use quiet/splash here. For Hyper-V, text mode is safest. Optionally append
# modules=hv_vmbus,hv_storvsc,hv_netvsc to the Text entry if you need explicit hv modules.

menuentry "Install NithronOS (Debian Installer - Text)" --class nithronos --class gnu-linux --class gnu --class os {
  echo "Starting NithronOS installer (text mode)..."
  linux   /install.amd/vmlinuz DEBIAN_FRONTEND=text priority=low vga=normal fb=false nomodeset console=tty0 ---
  initrd  /install.amd/initrd.gz
}

menuentry "Install NithronOS (Safe graphics)" --class nithronos --class gnu-linux --class gnu --class os {
  echo "Starting NithronOS installer (safe graphics)..."
  linux   /install.amd/vmlinuz DEBIAN_FRONTEND=text priority=low nomodeset fb=false vga=normal ---
  initrd  /install.amd/initrd.gz
}

menuentry "Install NithronOS (Serial console @ttyS0)" --class nithronos --class gnu-linux --class gnu --class os {
  echo "Starting NithronOS installer (serial console)..."
  linux   /install.amd/vmlinuz DEBIAN_FRONTEND=text priority=low console=ttyS0,115200n8 console=tty0 fb=false nomodeset ---
  initrd  /install.amd/initrd.gz
}

menuentry "Memory Test (memtest86+)" --class memtest {
  linux16 /live/memtest
}

menuentry "Boot from first hard disk" --class hdd {
  set root=(hd0)
  chainloader +1
}