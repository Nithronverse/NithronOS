# NithronOS Installer Preseed Configuration
# This file automates the Debian installer for NithronOS

#### Localization
d-i debian-installer/locale string en_US.UTF-8
d-i keyboard-configuration/xkb-keymap select us

#### Network configuration
d-i netcfg/choose_interface select auto
d-i netcfg/get_hostname string nithronos
d-i netcfg/get_domain string local
d-i netcfg/hostname string nithronos

# Disable network mirror (use only packages from ISO)
d-i apt-setup/use_mirror boolean false
d-i apt-setup/no_mirror boolean true
d-i apt-setup/cdrom/set-first boolean true
d-i apt-setup/cdrom/set-next boolean false
d-i apt-setup/cdrom/set-failed boolean false

#### Mirror settings (for updates after install)
d-i mirror/country string manual
d-i mirror/http/hostname string deb.debian.org
d-i mirror/http/directory string /debian
d-i mirror/http/proxy string

#### Account setup
# Skip root account creation (use sudo)
d-i passwd/root-login boolean false
d-i passwd/make-user boolean true
d-i passwd/user-fullname string NithronOS Administrator
d-i passwd/username string admin
# Password: nithronos (should be changed on first login)
d-i passwd/user-password-crypted password $6$rounds=4096$8cRqPvGxk$J5J5M7BVfW8uO.R7jRhXn5.C7QdpOqZxq1hYzRv2qX4mZQvhJpR.D4vwsD.4pxqGjBvKbWvGxPqGxPqGxPqGx.
d-i passwd/user-uid string 1000
d-i user-setup/allow-password-weak boolean true
d-i user-setup/encrypt-home boolean false

#### Clock and time zone setup
d-i clock-setup/utc boolean true
d-i time/zone string UTC
d-i clock-setup/ntp boolean true
d-i clock-setup/ntp-server string pool.ntp.org

#### Partitioning
# Use entire disk with Btrfs
d-i partman-auto/method string regular
d-i partman-auto/disk string /dev/sda
d-i partman-auto/choose_recipe select nithronos

# Custom partition recipe for NithronOS (EFI + Btrfs)
d-i partman-auto/expert_recipe string                         \
      nithronos ::                                            \
              512 512 1024 fat32                              \
                      $iflabel{ gpt }                          \
                      $reusemethod{ }                          \
                      method{ efi }                            \
                      format{ }                                \
              .                                                \
              1024 1024 -1 btrfs                             \
                      $primary{ }                              \
                      method{ format }                         \
                      format{ }                                \
                      use_filesystem{ }                       \
                      filesystem{ btrfs }                     \
                      mountpoint{ / }                          \
                      options/noatime{ noatime }              \
                      options/compress{ compress=zstd:3 }     \
              .

# Confirm partitioning
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true

# Force UEFI installation
d-i partman-efi/non_efi_system boolean true

#### Base system installation
d-i base-installer/install-recommends boolean true
d-i base-installer/kernel/image string linux-image-amd64

#### Package selection
tasksel tasksel/first multiselect standard, ssh-server
d-i pkgsel/include string \
    sudo vim htop curl wget git tmux \
    btrfs-progs zfs-dkms zfsutils-linux mdadm lvm2 \
    smartmontools hdparm nvme-cli \
    net-tools dnsutils iperf3 \
    systemd-timesyncd chrony \
    ufw fail2ban \
    docker-ce docker-ce-cli containerd.io docker-compose-plugin \
    caddy \
    build-essential linux-headers-$(uname -r) \
    python3 python3-pip \
    nodejs npm

# Install NithronOS specific packages
d-i pkgsel/include string nosd nos-agent nos-web nos-apps

# Upgrade packages after debootstrap
d-i pkgsel/upgrade select full-upgrade

# Popularity contest
popularity-contest popularity-contest/participate boolean false

#### Boot loader installation
d-i grub-installer/only_debian boolean true
d-i grub-installer/with_other_os boolean true
d-i grub-installer/bootdev string default

# Use GRUB EFI
d-i grub-installer/force-efi-extra-removable boolean true

#### Finishing up the installation
# Avoid that last message about the install being complete
d-i finish-install/reboot_in_progress note

# Eject CD
d-i cdrom-detect/eject boolean true

# Power off after install
d-i debian-installer/exit/poweroff boolean false
d-i debian-installer/exit/halt boolean false

#### Advanced options
# Prevent packaged version of /etc/hosts from being installed
d-i netcfg/get_hostname string nithronos
d-i netcfg/get_domain string local

# Late commands - run after base install
d-i preseed/late_command string \
    in-target mkdir -p /etc/nithronos; \
    in-target echo "NithronOS" > /etc/nithronos/brand; \
    in-target systemctl enable nosd nos-agent caddy; \
    in-target systemctl enable docker; \
    in-target usermod -aG docker,sudo admin; \
    in-target update-alternatives --set editor /usr/bin/vim.basic; \
    echo "NithronOS installation complete" > /target/etc/motd
