#!/bin/sh
# Display first-boot OTP in login MOTD if setup is pending

st=/var/lib/nos/state/firstboot.json
test -f "$st" || exit 0

# Check if first boot and not used
if grep -q '"used"[[:space:]]*:[[:space:]]*false' "$st" 2>/dev/null; then
    otp=$(sed -n 's/.*"otp"[[:space:]]*:[[:space:]]*"\([0-9]\{6\}\)".*/\1/p' "$st" 2>/dev/null | head -n1)
    if [ -n "$otp" ]; then
        # Get primary IP address
        ip_addr=$(ip -4 addr show scope global | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | head -n1)
        if [ -z "$ip_addr" ]; then
            ip_addr="<server-ip>"
        fi
        
        echo
        echo "=================================================================================="
        echo "  NithronOS first-boot OTP: $otp  (valid 15m)"
        echo "  Open http://nithron.os or http://$ip_addr to continue setup."
        echo "=================================================================================="
        echo
    fi
fi
