# NithronOS nftables policy template

table inet filter {
  chains {
    input {
      type filter hook input priority 0; policy drop;

      # Allow established/related traffic
      ct state established,related accept

      # Allow loopback
      iif lo accept

      # Allow ICMP (basic ping)
      ip protocol icmp accept
      ip6 nexthdr icmpv6 accept

      # Allow SSH from RFC1918
      ip saddr { 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16 } tcp dport 22 accept
      ip6 saddr fc00::/7 tcp dport 22 accept

      # Allow HTTP/HTTPS from RFC1918 only
      ip saddr { 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16 } tcp dport { 80, 443 } accept
      ip6 saddr fc00::/7 tcp dport { 80, 443 } accept

      # Allow SMB/CIFS from RFC1918 (ports 139, 445)
      ip saddr { 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16 } tcp dport { 139, 445 } accept
      ip6 saddr fc00::/7 tcp dport { 139, 445 } accept

      # Allow NFS from RFC1918 (rpcbind 111, nfs 2049)
      ip saddr { 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16 } tcp dport { 111, 2049 } accept
      ip saddr { 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16 } udp dport { 111, 2049 } accept
      ip6 saddr fc00::/7 tcp dport { 111, 2049 } accept
      ip6 saddr fc00::/7 udp dport { 111, 2049 } accept

      # Allow mDNS/Bonjour (port 5353) for Time Machine discovery
      udp dport 5353 accept

      # Drop everything else by default (policy drop)
    }

    forward {
      type filter hook forward priority 0; policy drop;
    }

    output {
      type filter hook output priority 0; policy accept;
    }
  }
}

# Modes (for future toggling)
# - VPN-only: Restrict input to VPN interface(s) only; do not open 443 on WAN
# - Tunnel: Allow 443 from tunnel provider ranges only (and enforce rate limits upstream)
# - Direct: Allow 443 from anywhere; MUST enforce 2FA and rate limits at proxy


